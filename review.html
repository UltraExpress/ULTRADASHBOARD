<!DOCTYPE html>
<html>
<head>
    <title>Flyer Image Review - Grid View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .image-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .image-wrapper {
            position: relative;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            background: #f1f5f9;
        }

        .image-wrapper img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-info {
            padding: 12px;
            background: white;
        }

        .bad-button {
            width: 100%;
            padding: 8px;
            background: #ef4444;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .bad-button:hover {
            background: #dc2626;
        }

        .bad-marker {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            z-index: 10;
        }

        .filters {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .filter-controls {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .stats {
            padding: 8px 16px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #475569;
        }

        select, .checkbox-wrapper {
            height: 38px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0 12px;
            background: white;
            min-width: 120px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            background: white;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
        }

        @media (max-width: 640px) {
            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay">Marking as bad...</div>
    <div id="root"></div>
    
    <script type="text/babel">
        const DataManager = {
            SHEET_ID: '1Q-Sk8g_h3FnY-NS4CQe_rEARCJkG0pYIL8Bfzws-Vp8',
            
            async fetchData() {
                try {
                    const response = await fetch(`https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:json`);
                    const text = await response.text();
                    const data = JSON.parse(text.substring(47).slice(0, -2));
                    return this.processData(data);
                } catch (error) {
                    console.error('Error fetching data:', error);
                    return null;
                }
            },

            processData(data) {
                if (!data || !data.table || !data.table.rows) {
                    return { images: [], users: [] };
                }
                
                const processedImages = data.table.rows
                    .map((row, index) => ({
                        rowIndex: index + 2,
                        timestamp: row.c[0]?.v,
                        username: row.c[1]?.v || 'Unknown',
                        community: row.c[2]?.v || 'Unknown',
                        lat: row.c[3]?.v,
                        lng: row.c[4]?.v,
                        photoUrl: row.c[5]?.v,
                        paid: row.c[6]?.v === 'YES',
                        bad: row.c[7]?.v === 'YES'
                    }))
                    .filter(img => img.photoUrl);

                const users = [...new Set(processedImages.map(img => img.username))]
                    .filter(Boolean)
                    .sort();

                return {
                    images: processedImages,
                    users: users
                };
            }
        };

        function ImageReviewApp() {
            const [images, setImages] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [users, setUsers] = React.useState([]);
            const [filter, setFilter] = React.useState({
                selectedUser: '',
                todayOnly: true,
                reviewStatus: 'all'
            });

            React.useEffect(() => {
                fetchImages();
            }, []);

            const parseDate = (timestamp) => {
                if (!timestamp) return null;
                // Handle Google Sheets date format: "Date(2024,1,1,12,0,0)"
                if (typeof timestamp === 'string' && timestamp.startsWith('Date(')) {
                    const params = timestamp.slice(5, -1).split(',').map(Number);
                    return new Date(params[0], params[1] - 1, params[2], params[3] || 0, params[4] || 0);
                }
                // Handle standard date string
                return new Date(timestamp);
            };

            const formatDate = (timestamp) => {
                const date = parseDate(timestamp);
                if (!date || isNaN(date)) return 'Unknown Date';
                return date.toLocaleString();
            };

            const fetchImages = async () => {
                setLoading(true);
                try {
                    const data = await DataManager.fetchData();
                    if (data) {
                        setImages(data.images);
                        setUsers(data.users);
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
                setLoading(false);
            };

            // Using the same script URL as the upload form
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9F2SIZ2FVg_HH98-3B-Q8EvbKM2IooNYtiQgonJ_jQRdqQTeNvb_77x55GW5ERFVrsg/exec';
            
            const markImageAsBad = async (image) => {
                try {
                    document.querySelector('.loading-overlay').style.display = 'flex';
                    
                    const formData = new URLSearchParams();
                    formData.append('rowIndex', image.rowIndex);  // The row number
                    formData.append('columnIndex', 8);           // Column H is 8
                    formData.append('value', 'YES');            // Setting the BAD value to YES
                            
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: formData
                    });

                    // Update local state and refetch data
                    const updatedImages = images.map(img => 
                        img.rowIndex === image.rowIndex ? {...img, bad: true} : img
                    );
                    setImages(updatedImages);
                    
                    setTimeout(() => {
                        document.querySelector('.loading-overlay').style.display = 'none';
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error marking image as bad:', error);
                    alert('Error updating image status. Please try again.');
                    document.querySelector('.loading-overlay').style.display = 'none';
                }
            };

            const isToday = (timestamp) => {
                const date = parseDate(timestamp);
                if (!date || isNaN(date)) return false;
                const today = new Date();
                return date.toDateString() === today.toDateString();
            };

            const filteredImages = images.filter(img => {
                if (filter.selectedUser && img.username !== filter.selectedUser) return false;
                if (filter.todayOnly && !isToday(img.timestamp)) return false;
                if (filter.reviewStatus === 'pending' && img.bad) return false;
                if (filter.reviewStatus === 'bad' && !img.bad) return false;
                return true;
            });

            const getImageUrl = (url) => {
                if (!url) return null;
                if (url.includes('/view?usp=drivesdk')) {
                    return url.replace('/view?usp=drivesdk', '/preview');
                }
                return url;
            };

            const pendingCount = filteredImages.filter(img => !img.bad).length;
            const badCount = filteredImages.filter(img => img.bad).length;

            return (
                <div>
                    <div className="filters">
                        <div className="filter-controls">
                            <select
                                value={filter.selectedUser}
                                onChange={(e) => setFilter(f => ({...f, selectedUser: e.target.value}))}
                                className="min-w-[200px]"
                            >
                                <option value="">All Users</option>
                                {users.map(user => (
                                    <option key={user} value={user}>{user}</option>
                                ))}
                            </select>

                            <div className="checkbox-wrapper">
                                <input
                                    type="checkbox"
                                    checked={filter.todayOnly}
                                    onChange={(e) => setFilter(f => ({...f, todayOnly: e.target.checked}))}
                                    id="today-only"
                                />
                                <label htmlFor="today-only">Today Only</label>
                            </div>

                            <select
                                value={filter.reviewStatus}
                                onChange={(e) => setFilter(f => ({...f, reviewStatus: e.target.value}))}
                            >
                                <option value="all">All Images</option>
                                <option value="pending">Pending Review</option>
                                <option value="bad">Marked as Bad</option>
                            </select>

                            <div className="stats">
                                Total Images: {filteredImages.length} | 
                                Pending Review: {pendingCount} | 
                                Marked Bad: {badCount}
                            </div>

                            <a href="index.html" className="ml-auto px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Back to Dashboard
                            </a>
                        </div>
                    </div>

                    {loading ? (
                        <div className="flex items-center justify-center h-64">
                            <div className="text-xl">Loading...</div>
                        </div>
                    ) : filteredImages.length === 0 ? (
                        <div className="flex items-center justify-center h-64 text-gray-500">
                            No images match the current filters
                        </div>
                    ) : (
                        <div className="image-grid">
                            {filteredImages.map((image) => (
                                <div key={image.rowIndex} className="image-card">
                                    {image.bad && (
                                        <div className="bad-marker">BAD</div>
                                    )}
                                    <div className="image-wrapper">
                                        <img
                                            src={getImageUrl(image.photoUrl)}
                                            alt={`${image.community} by ${image.username}`}
                                        />
                                    </div>
                                    <div className="image-info">
                                        <div className="font-medium">{image.community}</div>
                                        <div className="text-sm text-gray-600">
                                            {image.username}<br/>
                                            {formatDate(image.timestamp)}
                                        </div>
                                    </div>
                                    {!image.bad && (
                                        <button
                                            onClick={() => markImageAsBad(image)}
                                            className="bad-button"
                                        >
                                            Mark as Bad
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<ImageReviewApp />);
    </script>
</body>
</html>
