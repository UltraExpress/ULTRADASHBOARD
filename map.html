<!DOCTYPE html>
<html>
<head>
    <title>Flyer Locations Map</title>
    <style>
        #map { height: 100vh; width: 100%; }
        body { margin: 0; }
        .info-window { max-width: 300px; }
        .info-window iframe { 
            max-width: 100%; 
            height: 200px; 
            margin-top: 10px;
            border-radius: 4px;
        }
        .marker-label {
            background-color: white;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
      
        
        
        
        
        
        
        
function formatDate(dateStr) {
    if (!dateStr) return 'No date provided';
    
    try {
        // Split the date string (e.g., "12/12/2024 12:12:34")
        const [date, time] = dateStr.split(' ');
        if (date && time) {
            const [month, day, year] = date.split('/');
            const [hour, minute] = time.split(':');
            
            // Create date object
            const dateObj = new Date(year, month - 1, day, hour, minute);
            
            // Format to "JAN 24th 2024 12:12 PM"
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const getOrdinal = (n) => {
                const s = ['th', 'st', 'nd', 'rd'];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            };
            
            return `${months[dateObj.getMonth()]} ${getOrdinal(dateObj.getDate())} ${dateObj.getFullYear()} ${dateObj.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            })}`;
        }
    } catch (e) {
        console.error('Error formatting date:', e);
    }
    
    return dateStr; // Fallback to original string if parsing fails
}









        

        function getGoogleDriveImageUrl(url) {
            if (!url) return '';
            return url.replace('/view?usp=drivesdk', '/preview');
        }

        
        
        
        
        
        
        
function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: { lat: 33.93864, lng: -84.4953 }, // Default center
        minZoom: 3,
        maxZoom: 18,
        restriction: {
            latLngBounds: {
                north: 85,
                south: -85,
                west: -180,
                east: 180
            }
        }
    });

    let currentInfoWindow = null;

    const SHEET_ID = '1Q-Sk8g_h3FnY-NS4CQe_rEARCJkG0pYIL8Bfzws-Vp8';
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`)
        .then(response => response.text())
        .then(text => {
            const data = JSON.parse(text.substring(47).slice(0, -2));
            let hasValidMarkers = false;
            
            // Improved timestamp parsing and sorting
            const sortedRows = data.table.rows
                .map(row => ({
                    timestamp: row.c[0]?.v,
                    data: row,
                    date: row.c[0]?.v ? new Date(row.c[0].v.replace(/(\d{1,2})\/(\d{1,2})\/(\d{4})/, '$3-$1-$2')) : new Date(0)
                }))
                .sort((a, b) => b.date - a.date); // Sort by parsed date

            // Get valid coordinates from the most recent entries first
            const recentValidPins = [];
            for (let i = 0; i < sortedRows.length && recentValidPins.length < 5; i++) {
                const row = sortedRows[i].data;
                const lat = row.c[3]?.v;
                const lng = row.c[4]?.v;
                
                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    recentValidPins.push({ lat, lng });
                }
            }

            // Center map on recent pins if we have any
            if (recentValidPins.length > 0) {
                const recentBounds = new google.maps.LatLngBounds();
                recentValidPins.forEach(coord => recentBounds.extend(coord));
                
                // First set center to the first recent pin
                map.setCenter(recentValidPins[0]);
                
                // Then fit bounds if we have multiple pins
                if (recentValidPins.length > 1) {
                    map.fitBounds(recentBounds);
                    
                    // Adjust zoom after bounds are set
                    google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                        const zoom = map.getZoom();
                        if (zoom > 15) map.setZoom(15);
                        if (zoom < 10) map.setZoom(10);
                    });
                } else {
                    map.setZoom(13); // Default zoom for single pin
                }
            }

            // Process all markers
            sortedRows.forEach(({data: row}) => {
                const timestamp = row.c[0]?.v;
                const username = row.c[1]?.v;
                const community = row.c[2]?.v;
                const lat = row.c[3]?.v;
                const lng = row.c[4]?.v;
                const originalPhotoUrl = row.c[5]?.v;
                
                const photoUrl = getGoogleDriveImageUrl(originalPhotoUrl);
                let fileId = '';
                if (originalPhotoUrl) {
                    if (originalPhotoUrl.includes('/file/d/')) {
                        fileId = originalPhotoUrl.match(/\/file\/d\/([^/]+)/)?.[1];
                    } else if (originalPhotoUrl.includes('id=')) {
                        fileId = originalPhotoUrl.match(/id=([^&]+)/)?.[1];
                    }
                }

                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    hasValidMarkers = true;

                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        map: map,
                        title: community || 'Unknown Location',
                        label: {
                            text: community || 'Unknown',
                            className: 'marker-label',
                            color: 'black'
                        }
                    });

                    const formattedDate = formatDate(timestamp);
                    const infoContent = `
                        <div class="info-window">
                            <h3>${community || 'Unknown Location'}</h3>
                            <p>Posted by: ${username || 'Anonymous'}</p>
                            <p>Date: ${formattedDate}</p>
                            ${photoUrl ? `
                                <iframe src="${photoUrl}" frameborder="0"></iframe>
                                ${fileId ? `
                                    <p><a href="https://drive.google.com/file/d/${fileId}/view" target="_blank">View Full Size</a></p>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;

                    const infowindow = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infowindow.open(map, marker);
                        currentInfoWindow = infowindow;
                    });
                }
            });
        })
        .catch(error => {
            console.error('Error loading map data:', error);
        });

    map.addListener('click', () => {
        if (currentInfoWindow) {
            currentInfoWindow.close();
        }
    });
}









        
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC12ICnLkz1Td_Le-ZcjFy_vjWKgdPYXBQ&callback=initMap">
    </script>
</body>
</html>
