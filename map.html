<!DOCTYPE html>
<html>
<head>
    <title>Flyer Locations Map</title>
    <style>
        #map { height: 100vh; width: 100%; }
        body { margin: 0; }
        .info-window { max-width: 300px; }
        .info-window iframe { 
            max-width: 100%; 
            height: 200px; 
            margin-top: 10px;
            border-radius: 4px;
        }
        .marker-label {
            background-color: white;
            padding: 2px 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
      
        
        
        
        
        
        
        
function formatDate(dateStr) {
    if (!dateStr) return 'No date provided';
    
    try {
        // Split the date string (e.g., "12/12/2024 12:12:34")
        const [date, time] = dateStr.split(' ');
        if (date && time) {
            const [month, day, year] = date.split('/');
            const [hour, minute] = time.split(':');
            
            // Create date object
            const dateObj = new Date(year, month - 1, day, hour, minute);
            
            // Format to "JAN 24th 2024 12:12 PM"
            const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            const getOrdinal = (n) => {
                const s = ['th', 'st', 'nd', 'rd'];
                const v = n % 100;
                return n + (s[(v - 20) % 10] || s[v] || s[0]);
            };
            
            return `${months[dateObj.getMonth()]} ${getOrdinal(dateObj.getDate())} ${dateObj.getFullYear()} ${dateObj.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            })}`;
        }
    } catch (e) {
        console.error('Error formatting date:', e);
    }
    
    return dateStr; // Fallback to original string if parsing fails
}









        

        function getGoogleDriveImageUrl(url) {
            if (!url) return '';
            return url.replace('/view?usp=drivesdk', '/preview');
        }

        
        
        
        
        
        
        
function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: { lat: 33.93864, lng: -84.4953 }, // Default center, will be updated
        minZoom: 3,
        maxZoom: 18,
        restriction: {
            latLngBounds: {
                north: 85,
                south: -85,
                west: -180,
                east: 180
            }
        }
    });

    let currentInfoWindow = null;

    const SHEET_ID = '1Q-Sk8g_h3FnY-NS4CQe_rEARCJkG0pYIL8Bfzws-Vp8';
    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`)
        .then(response => response.text())
        .then(text => {
            const data = JSON.parse(text.substring(47).slice(0, -2));
            let hasValidMarkers = false;
            
            // Convert rows to array and sort by timestamp (most recent first)
            const sortedRows = data.table.rows
                .map(row => ({
                    timestamp: row.c[0]?.v,
                    data: row
                }))
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Get coordinates of the most recent valid pins (latest 5)
            const recentValidPins = sortedRows
                .slice(0, 5)  // Take latest 5 entries
                .map(row => {
                    const lat = row.data.c[3]?.v;
                    const lng = row.data.c[4]?.v;
                    return (lat && lng && !isNaN(lat) && !isNaN(lng)) ? { lat, lng } : null;
                })
                .filter(coord => coord !== null);  // Remove any invalid coordinates

            // Create bounds for recent pins
            if (recentValidPins.length > 0) {
                const recentBounds = new google.maps.LatLngBounds();
                recentValidPins.forEach(coord => recentBounds.extend(coord));
                
                // Center map on recent pins
                map.fitBounds(recentBounds);
                
                // Adjust zoom if too far out or in
                google.maps.event.addListenerOnce(map, 'bounds_changed', () => {
                    if (map.getZoom() > 15) map.setZoom(15);
                    if (map.getZoom() < 10) map.setZoom(10);
                });
            }

            // Process all markers (including old ones)
            sortedRows.forEach(({data: row}) => {
                const timestamp = row.c[0]?.v;
                const username = row.c[1]?.v;
                const community = row.c[2]?.v;
                const lat = row.c[3]?.v;
                const lng = row.c[4]?.v;
                const originalPhotoUrl = row.c[5]?.v;
                
                const photoUrl = getGoogleDriveImageUrl(originalPhotoUrl);
                let fileId = '';
                if (originalPhotoUrl) {
                    if (originalPhotoUrl.includes('/file/d/')) {
                        fileId = originalPhotoUrl.match(/\/file\/d\/([^/]+)/)?.[1];
                    } else if (originalPhotoUrl.includes('id=')) {
                        fileId = originalPhotoUrl.match(/id=([^&]+)/)?.[1];
                    }
                }

                if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    hasValidMarkers = true;

                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        map: map,
                        title: community || 'Unknown Location',
                        label: {
                            text: community || 'Unknown',
                            className: 'marker-label',
                            color: 'black'
                        }
                    });

                    const formattedDate = formatDate(timestamp);
                    const infoContent = `
                        <div class="info-window">
                            <h3>${community || 'Unknown Location'}</h3>
                            <p>Posted by: ${username || 'Anonymous'}</p>
                            <p>Date: ${formattedDate}</p>
                            ${photoUrl ? `
                                <iframe src="${photoUrl}" frameborder="0"></iframe>
                                ${fileId ? `
                                    <p><a href="https://drive.google.com/file/d/${fileId}/view" target="_blank">View Full Size</a></p>
                                ` : ''}
                            ` : ''}
                        </div>
                    `;

                    const infowindow = new google.maps.InfoWindow({
                        content: infoContent
                    });

                    marker.addListener('click', () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        infowindow.open(map, marker);
                        currentInfoWindow = infowindow;
                    });
                }
            });
        })
        .catch(error => {
            console.error('Error loading map data:', error);
        });

    map.addListener('click', () => {
        if (currentInfoWindow) {
            currentInfoWindow.close();
        }
    });
}









        
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC12ICnLkz1Td_Le-ZcjFy_vjWKgdPYXBQ&callback=initMap">
    </script>
</body>
</html>
